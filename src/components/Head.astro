---
import appleTouchIcon from "@/assets/apple-touch-icon.png";
import ogImage from "@/assets/opengraph-image.png";
import site from "@/data/site";
import type { ImageMetadata } from "astro";
import { getImage } from "astro:assets";

export interface Props {
    canonicalURL?: URL | null;
    description?: string;
    image?: { data: ImageMetadata; alt: string };
    rawTitle?: string;
    title?: string;
}

const {
    canonicalURL = new URL(Astro.request.url, Astro.site),
    description = site.description,
    image = {
        data: await getImage({ src: ogImage, format: "png", width: 1200, height: 630 }),
        alt: "Ep√§tarkka kuva Welsh corgi pembroke -pentu Tovesta juoksemassa",
    },
    rawTitle,
} = Astro.props;

const title = rawTitle ?? [Astro.props.title, site.name].filter(Boolean).join(" - ");

const resolvedImage = {
    src: new URL(image.data.src, Astro.site).toString(),
    alt: image.alt,
};

/**
 * Enforce some standard canonical URL formatting across the site.
 */
function formatCanonicalURL(url: string | URL): string {
    const path = url.toString();
    const hasQueryParams = path.includes("?");
    // If there are query params, make sure the URL has no trailing slash
    if (hasQueryParams) {
        path.replace(/\/?$/, "");
    }
    // otherwise, canonical URL always has a trailing slash
    return path.replace(/\/?$/, hasQueryParams ? "" : "/");
}
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>{title}</title>

<link rel="icon" href="/favicon.ico" sizes="32x32" />
<link rel="apple-touch-icon" href={appleTouchIcon.src} />

{canonicalURL && <link rel="canonical" href={formatCanonicalURL(canonicalURL)} />}

<meta name="description" content={description} />

{Astro.url.pathname.startsWith("/ohje/") && <meta name="robots" content="noindex, nofollow" />}

<meta property="og:title" content={rawTitle ?? Astro.props.title} />
<meta property="og:type" content="website" />
{canonicalURL && <meta property="og:url" content={formatCanonicalURL(canonicalURL)} />}
<meta property="og:locale" content="fi_FI" />
<meta property="og:description" content={description} />
<meta property="og:site_name" content={site.name} />
<meta property="og:image" content={resolvedImage.src} />
<meta property="og:image:alt" content={resolvedImage.alt} />
